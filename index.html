<!DOCTYPE html>
<html>  
    <head>
        <title>Example 01.01 - Basic skeleton</title>
        <script type="text/javascript" src="libs/three.min.js"></script>
        <!--script type="text/javascript" src="libs/stats.min.js"></script-->
        <!--script type="text/javascript" src="libs/dat.gui.min.js"></script-->
        <script type="text/javascript" src="libs/jquery-1.11.2.min.js"></script>

        <style>
        body{
        /* set margin to 0 and overflow to hidden, 
        to use the complete page */
        margin: 0;
        overflow: hidden;
        }
        </style>
    </head>
    <body>
        <!--Div which will hold the Output -->
        <div id="WebGL-output"></div>

        <!--Div which stat hold the Output -->
        <!--div id="Stats-output"></div-->

        <!--Javascript code that runs our Three.js examples -->
        <script type="text/javascript">
        // once everything is loaded, we run our Three.js stuff.
        $(function () {

    var i = 0;


    // // Контроллеры интерфейс
    // var controls = new function() {
    //     // this.rotationSpeed = 0.02;
    //     // this.bouncingSpeed = 0.03;
    //     this.cameraPositionX = 0;
    //     //this.monsterRotate = 0;
    // }
    // var gui = new dat.GUI();
    // // gui.add(controls, 'rotationSpeed',0,0.5);
    // // gui.add(controls, 'bouncingSpeed',0,0.5);
    // gui.add(controls, 'cameraPositionX',0,100);
    // //gui.add(controls, 'monsterRotate',0,360);

    // // Функция инициализации вывода статистики
    // function initStats() {
    //     var stats = new Stats();
    //     stats.setMode(0);
    //     stats.domElement.style.position = 'absolute';
    //     stats.domElement.style.left = '0px';
    //     stats.domElement.style.top = '0px';
    //     $("#Stats-output").append(stats.domElement );
    //     return stats;
    // }
    
    // вычисление угла по координатам центра и точки
    function get_angle(x, y){
        if(x==0) return (y>0) ? 180 : 0;
        var a = Math.atan(y/x)*180/Math.PI;
        a = (x > 0) ? a+90 : a+270;
        a = (a<180) ? a+180 : a-180;
        return a;
    }
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }


    //var stats = initStats();

    var scene = new THREE.Scene();

    //var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight , 0.1, 1000);
    var camS = 0.05;
    var camW = window.innerWidth*camS;
    var camH = window.innerHeight*camS;
    var camera = new THREE.OrthographicCamera(  camW / - 2, camW / 2, camH / 2, camH / - 2, 1, 31 );

    // Добавляем рендер
    var renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
    renderer.setClearColorHex(0xEEEEEE, 1.0);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMapEnabled = true


    // Земля
    var groungList = [
        'grass.01.01.png', 'grass.01.02.png', 'grass.01.03.png', 'grass.01.04.png', 'grass.01.05.png', 'grass.01.06.png', 'grass.01.07.png',
        'grass.02.01.png', 'grass.02.02.png', 'grass.02.03.png', 'grass.02.04.png', 'grass.02.05.png', 'grass.02.06.png',
        'grass.03.01.png', 'grass.03.02.png', 'grass.03.03.png', 'grass.03.04.png', 'grass.03.05.png', 'grass.03.06.png', 'grass.03.07.png',
        'sand.01.01.png', 
        'sand.02.01.png', 'sand.02.02.png', 'sand.02.03.png', 'sand.02.04.png'
    ];
    var groungTexture = [];
    var groungMaterial = [];
    i = 0;
    for(i=0;i<25;i++){
        groungTexture[i] = THREE.ImageUtils.loadTexture( 'img/tiles/'+groungList[i] );
        groungTexture[i].anisotropy = renderer.getMaxAnisotropy();
        groungMaterial[i] = new THREE.MeshBasicMaterial( { map: groungTexture[i], transparent: true, opacity: 1.0} );
    }

    var pX=0;
    var pY=0;
    var groungPlaneGeometry = [];
    var groungPlane = [];
    for(pX=-5;pX<5;pX++){
        groungPlane[pX] = [];
        groungPlaneGeometry[pX] = [];
        for(pY=-5;pY<5;pY++){
            groungPlaneGeometry[pX][pY] = new THREE.PlaneGeometry(6,6);
            var r = getRandomInt(20,24);
            console.log('r: ['+r+']');
            groungPlane[pX][pY] = new THREE.Mesh(groungPlaneGeometry[pX][pY],groungMaterial[r]);

            groungPlane[pX][pY].rotation.x = -0.5*Math.PI;
            groungPlane[pX][pY].rotation.z = -0.5*Math.PI;

            groungPlane[pX][pY].position.x = pX*3;
            groungPlane[pX][pY].position.y = Math.random();
            groungPlane[pX][pY].position.z = pY*3;
            
            if(pX%2){ groungPlane[pX][pY].position.y += 0.01; }
            if(pY%2){ groungPlane[pX][pY].position.y += 0.02; }

            if(r==20){ groungPlane[pX][pY].position.y += 1; }
            
            scene.add(groungPlane[pX][pY]);
    }}

    // Добавляем монстра
    var monsterTexture = [];
    var monsterMaterial;
    i = 0;
    for(i=0;i<22;i++){
        var count = ''+(i+1);
        if(count<10){ count='0'+count; }

        monsterTexture[i] = THREE.ImageUtils.loadTexture( 'img/sprites/zombie02/zombie02.walk01.'+count+'.png' );
        //monsterTexture[i].premultiplyAlpha = true;
        monsterTexture[i].anisotropy = renderer.getMaxAnisotropy();
    }
    monsterMaterial = new THREE.MeshBasicMaterial( { map: monsterTexture[0], transparent: true, opacity: 1.0} );
    //monsterMaterial = new THREE.MeshBasicMaterial( { map: monsterTexture[i]} );
    
    var monsterPlaneGeometry = new THREE.PlaneGeometry(6,8);
    var monsterPlane = new THREE.Mesh(monsterPlaneGeometry,monsterMaterial);

    monsterPlane.castShadow = true;
    monsterPlane.rotation.x = -0.5*Math.PI;
    monsterPlane.rotation.z = -0.5*Math.PI;
    monsterPlane.position.x = 0;
    monsterPlane.position.y = 3;
    monsterPlane.position.z = 0;
    scene.add(monsterPlane);


    // Добавляем курсор
    // Добавляем монстра
    var cursorTexture = THREE.ImageUtils.loadTexture( 'img/aim.png' );;
    cursorTexture.anisotropy = renderer.getMaxAnisotropy();
    var cursorMaterial = new THREE.MeshBasicMaterial( { map: cursorTexture, transparent: true, opacity: 0.8} );
    var cursorPlaneGeometry = new THREE.PlaneGeometry(2,2);
    var cursorPlane = new THREE.Mesh(cursorPlaneGeometry,cursorMaterial);

    cursorPlane.castShadow = true;
    cursorPlane.rotation.x = -0.5*Math.PI;
    cursorPlane.rotation.z = -0.5*Math.PI;
    cursorPlane.position.x = 0;
    cursorPlane.position.y = 6;
    cursorPlane.position.z = 0;
    scene.add(cursorPlane);

    // управление мышкой
    document.addEventListener('mousemove', function (event){
        var z = -((event.clientX-window.innerWidth/2)*camS);
        var x = (event.clientY-window.innerHeight/2)*camS;
        cursorPlane.position.z = z;
        cursorPlane.position.x = x;
        var angle = get_angle(z,x);
        monsterPlane.rotation.z = (angle/360)*2*Math.PI;

    })

    // Настраиваем позицию камеры
    camera.position.x = 0;
    camera.position.y = 30;
    camera.position.z = 0;
    camera.lookAt(scene.position);

    // Добавление источника света
    var spotLight = new THREE.SpotLight( 0xffffff );
    spotLight.position.set( -40, 60, -10 );
    scene.add(spotLight );
    spotLight.castShadow = true;

    // Добавляем функцию обновления рендера
    var fps = 20;
    var step = 0;
    var i = 0;
    function renderScene() {
        setTimeout(function() {
            monsterMaterial.map=monsterTexture[i];
            i++;
            if( i>=22 ){ i=0; }

            camera.position.x = 0; //controls.cameraPositionX;
            camera.lookAt(scene.position);

            // перерисовываем статистику и рендер
            //stats.update();
            requestAnimationFrame(renderScene);
            renderer.render(scene, camera);
        }, 1000/fps);
    }
    
    

    $("#WebGL-output").append(renderer.domElement);
    renderScene();

});
        </script>
    </body>
</html>